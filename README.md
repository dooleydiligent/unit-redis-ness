# unit-redis-ness
![dooley](https://dooleydiligent.github.io/unit-redis-ness/doc/images/dooley.gif)

- A fully in-memory ![Redis][redis] redis implementation in typescript to aid unit testing of redis-based nodejs applications.  Brought to you by [yours truly!](http://www.joeandlane.com)

Initially inspired by [mini-redis](https://github.com/meteor/miniredis) but ulitimately adapted from the very well-designed [ClauDB](https://github.com/tonivade/claudb.git)

The reason?  I 100% agree with [Antonio](https://github.com/tonivade)

- "Just For Fun!"

But also because I had need of redis for unit testing on my last project, where we used [bull](https://www.npmjs.com/package/bull).  But I found it difficult to unit test the queue processors without spinning up a fully functional redis implementation.  Since we use CI/CD it was not practical to have a redis farm just for testing.  Instead I embedded a klunky precursor to this project and never felt good about it.

Now I feel good.

Well, better.

This project is released under the [MIT license](https://opensource.org/licenses/MIT).  It includes work from some fine projects such as:
- [fengari](https://fengari.io/) - The Lua VM written in JS ES6 for Node and the browser
- [resp](https://www.npmjs.com/package/resp) - An implementation of the Redis Encoding and Serialization Protocol for Node.js.
- [redis-sorted-set](https://www.npmjs.com/package/redis-sorted-set) - A JavaScript implementation of Redis' Sorted Sets (Converted to typescript)


### [Code Coverage Report](https://dooleydiligent.github.io/unit-redis-ness/coverage/index.html)
### [Mochawesome Report](https://dooleydiligent.github.io/unit-redis-ness/mochawesome/mochawesome.html)
The full unit-test suite is tested against redis v5.0.5 with each release
### [Code Documentation](https://dooleydiligent.github.io/unit-redis-ness/doc/index.html)
### [Repository](https://github.com/dooleydiligent/unit-redis-ness)
### Recent activity
##### As of **1.0.11** 2020-01-22
  - Install fengari direct from git to get latest code
  - Implemented HGETALL, ZSCORE, ZRANGEBYSCORE, and PEXPIRE
  - Implemented LUA BIT library
  - Validated test suite against redis 5.0.5
  - Validated against BULL
##### As of **1.0.10**
**unit-redis-ness** has a more-or-less fully functional embedded LUA instance (fengari), which includes a rudimentary LUA [bit](http://bitop.luajit.org/) library, and it can process complex scripts generated by [Bull](https://www.npmjs.com/package/bull).  Many thanks to the developer(s) of [flua](https://www.npmjs.com/package/flua) who helped to demystify [fengari](https://www.npmjs.com/package/fengari) and LUA in general.

Unfortunately the code became spaghetti during refactoring for SUBSCRIBE, PUBLISH, DISCARD, and blocking commands BRPOP, BLPOP, and BRPOPLPUSH so a wholesale refactoring is underway.

The current suite of 287 tests has been validated against an actual redis 5.0.5 instance.
# How to use
Have a look at the skeleton project [test-unit-redisness](https://github.com/dooleydiligent/unit-redis-ness/tree/master/test-unit-redis-ness) included with the distribution. Or read along here:

```
npm install -D unit-redis-ness mocha @types/node chai net source-map-support ts-node typescript @types/chai @types/mocha
```
Configure ./test/mocha.opts like so (if you don't already have it configured):
```
--require source-map-support/register
--require ts-node/register
--full-trace
--bail
--timeout=5000
test/**/*.test.ts test/*.test.ts
```
Use this template:
```
import { RespServer, sendCommand } from 'unit-redis-ness';
import { expect } from 'chai';
import 'mocha';
import * as net from 'net';

process.env.REDIS_HOST = '127.0.0.1';
process.env.REDIS_PORT = '6378';

const respServer = new RespServer();
const client: net.Socket = new net.Socket();

before((done) => {
  respServer.on('ready', () => {
    console.log(`The redis server is ready to test your application`);
    done();
  });
  respServer.start();
});

after((done) => {
  respServer.on('closed', () => {
    console.log(`The redis server has shut down`);
    done();
  });
  respServer.stop();
});

describe('Some test suite', () => {
  it('should start the redis server and allow a connection', async () => {
    const response = await sendCommand(client, ['PING']);
    expect(response).to.be.a('string');
    expect(response).to.equal('PONG');
  });
})
```
# Current State
As of 1.0.4 **unit-redis-ness** includes embedded [fengari](https://www.npmjs.com/package/fengari), which means that LUA is now available.

All of the current test suite has been validated against a live redis instance (except for tests involving MAX_SAFE_INTEGER and MIN_SAFE_INTEGER - these are only 53 bits in unit-redis-ness)

As of **v1.0.9, unit-redis-net** supports 8 "server" commands:

- ping
- echo
- time
- quit
- info
- publish
- subscribe
- unsubscribe

Plus these "database" commands:

- get
- set
- exists
- del
- hset
- hget
- incr
- decr
- incrby
- decrby
- client (partial)
- select
- dbsize
- sadd
- scard
- sismember
- smembers
- smove
- zadd
- zrange
- zcount
- zcard
- zincrby
- zrem
- type
- script
- eval
- evalsha
- expire
- rename
- flushdb
- flushall
- keys
- mset
- llen
- lindex
- rpop
- rpush
- move
- getset
- lpop
- lpush
- lset
- lrange
- lrem
- zrank
- ltrim
- mget
- randomkey
- renamenx
- rpoplpush
- sdiff
- setnx
- sinter
- sinterstore
- srem
- sunion
- sunionstore
- ttl
- brpop
- blpop
- brpoplpush
- exec
- multi
- discard

Todo (to complete v1.0.0 command set)

- sort
- spop
- srandmember

Probably Won't do

- auth
- bgsave
- monitor
- save
- shutdown
- slaveof
- anything that involves replication, clustering, or persistence to disk

This is, after all, intended as a unit test tool

# Future plans

Time permitting, I expect to:

- implement the full redis command set up to [2.6.x](http://download.redis.io/releases/) (maybe later)
<img width="100px" src="https://dooleydiligent.github.io/unit-redis-ness/doc/images/redis-white.png"><br/>


<del>- embed [lua](https://www.lua.org/)<img width="100px" src="https://dooleydiligent.github.io/unit-redis-ness/doc/images/luaa.gif"></del> (completed)<br/>

- circle back around to validate that [Bull](https://www.npmjs.com/package/bull ) can be thoroughly tested
<img width="100px" src="https://dooleydiligent.github.io/unit-redis-ness/doc/images/bull.png"><br/>

[Redis]: https://dooleydiligent.github.io/unit-redis-ness/doc/images/redis.png